local SERVER_ID = 114
local PORT = 1384
local modem = peripheral.find("modem") or error("No modem found")
modem.open(os.getComputerID())

local username = "Debugger"
local contacts = {}
local connected = false

print("Debug Client v6 started.")
print("Target Server ID: " .. SERVER_ID)
print("My ID: " .. os.getComputerID())
print(string.rep("-", 40))

-- Функция отправки запроса
local function sendHandshake()
    modem.transmit(SERVER_ID, PORT, {type = "handshake", user = username})
    print("Sent handshake to " .. SERVER_ID)
end

-- Первый запрос
sendHandshake()

while true do
    -- Ждем ЛЮБОЕ событие
    local event, p1, p2, p3, p4 = os.pullEvent()

    if event == "modem_message" and p3 == SERVER_ID and type(p4) == "table" then
        if p4.type == "status" then
            if not connected then
                print("SUCCESS: Connected to server! Status received.")
                connected = true
            end
            contacts = p4.users
            print("Current online users: " .. table.concat(contacts, ", "))
            
        elseif p4.type == "msg" then
            print("MESSAGE from " .. p4.from .. ": " .. p4.text)
        end
    
    elseif event == "timer" and p1 == timer_id then
        -- Если таймер сработал, а ответа нет
        if not connected then
             print("STATUS: Still waiting for server response...")
             sendHandshake() -- Повторяем запрос
        end
    end
    
    -- Устанавливаем таймер для повторной попытки или проверки статуса
    timer_id = os.startTimer(3)
end
